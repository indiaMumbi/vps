name: Persistent VPS with Tailscale + Tmate

on:
  workflow_dispatch:
    inputs:
      username:
        description: 'VPS Username'
        required: true
        default: 'myuser'
      password:
        description: 'VPS Password'
        required: true
        default: 'mypassword'
  schedule:
    - cron: '0 */6 * * *'  # Restart every 6 hours

jobs:
  vps:
    runs-on: ubuntu-latest
    timeout-minutes: 357
    steps:
    - name: Set up persistent storage
      uses: actions/cache@v3
      with:
        path: storage
        key: persistent-vps-storage

    - name: Set up VPS
      run: |
        sudo apt update
        sudo apt install -y curl unzip openssh-server tmate

        # Create persistent user
        mkdir -p storage/home
        sudo useradd -m -d $PWD/storage/home/${{ github.event.inputs.username || 'myuser' }} -s /bin/bash ${{ github.event.inputs.username || 'myuser' }} || true
        sudo usermod -d $PWD/storage/home/${{ github.event.inputs.username || 'myuser' }} ${{ github.event.inputs.username || 'myuser' }}
        echo "${{ github.event.inputs.username || 'myuser' }}:${{ github.event.inputs.password || 'mypassword' }}" | sudo chpasswd

        # Start SSH server
        sudo service ssh start

        # Install Tailscale
        curl -fsSL https://tailscale.com/install.sh | sh
        sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTHKEY }} --ssh --hostname=vps-${{ github.run_id }}

        # Start tmate session in background and capture SSH
        TMATE_LOG="tmate_output.txt"
        tmate -F > $TMATE_LOG 2>&1 &
        sleep 15  # Wait for tmate to start
        TMATE_SSH=$(grep -o 'ssh [^ ]*' $TMATE_LOG | head -n 1)

        # Save info to file for Discord bot to DM
        IP4=$(curl -s4 https://ifconfig.me)
        TAILSCALE_IP=$(tailscale ip -4)
        USERNAME=${{ github.event.inputs.username || 'myuser' }}
        PASSWORD=${{ github.event.inputs.password || 'mypassword' }}

        echo "Username: $USERNAME" > vps_info.txt
        echo "Password: $PASSWORD" >> vps_info.txt
        echo "Public IPv4: $IP4" >> vps_info.txt
        echo "Tailscale IP: $TAILSCALE_IP" >> vps_info.txt
        echo "Tailscale SSH: ssh $USERNAME@$TAILSCALE_IP" >> vps_info.txt
        echo "Tmate SSH: $TMATE_SSH" >> vps_info.txt

        cat vps_info.txt

        # Keep VPS alive
        sleep 6h
