name: Persistent VPS with Tmate + Tailscale

on:
  workflow_dispatch:
    inputs:
      vps_name:
        description: "VPS Name"
        required: true
      vps_pass:
        description: "VPS Password"
        required: true
      discord_id:
        description: "Discord User ID"
        required: true

  schedule:
    - cron: '0 */6 * * *'  # Restart every 6 hours

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    steps:
    - name: Set up persistent volume
      uses: actions/cache@v3
      with:
        path: vps_data
        key: vps-persist-${{ github.event.inputs.vps_name || 'default' }}

    - name: Create VPS folder
      run: mkdir -p vps_data/${{ github.event.inputs.vps_name || 'default' }}

    - name: Install tools
      run: |
        sudo apt update
        sudo apt install -y openssh-server tmate curl unzip

    - name: Set root password
      run: echo "root:${{ github.event.inputs.vps_pass }}" | sudo chpasswd

    - name: Enable SSH
      run: sudo systemctl enable ssh && sudo systemctl start ssh

    - name: Setup tmate
      run: |
        tmate -S /tmp/tmate.sock new-session -d
        tmate -S /tmp/tmate.sock wait tmate-ready
        echo "SSH: $(tmate -S /tmp/tmate.sock display -p '#{tmate_ssh}')" > tmate.txt
        echo "Web: $(tmate -S /tmp/tmate.sock display -p '#{tmate_web}')" >> tmate.txt

    - name: Setup Tailscale
      run: |
        curl -fsSL https://tailscale.com/install.sh | sh
        sudo tailscale up --ssh --accept-routes --accept-dns=false

    - name: Get Tailscale IP
      run: |
        echo "Tailscale IP: $(tailscale ip -4)" >> tmate.txt

    - name: Save VPS Info
      run: |
        echo "Name: ${{ github.event.inputs.vps_name }}" >> tmate.txt
        echo "Password: ${{ github.event.inputs.vps_pass }}" >> tmate.txt

    - name: DM Discord User
      env:
        DISCORD_WEBHOOK: https://discord.com/api/v9/users/${{ github.event.inputs.discord_id }}/messages
        BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
      run: |
        curl -X POST -H "Authorization: Bot $BOT_TOKEN" -H "Content-Type: application/json" \
        --data "{\"content\": \"\`\`\`$(cat tmate.txt)\`\`\`\"}" \
        $DISCORD_WEBHOOK
