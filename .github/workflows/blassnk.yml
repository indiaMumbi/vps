name: Persistent VPS with SSHX + Tailscale

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 357
    steps:
    - name: Set up persistent volume
      uses: actions/cache@v3
      with:
        path: storage
        key: persistent-storage

    - name: Setup VPS
      run: |
        sudo apt update
        sudo apt install -y curl unzip openssh-server
        
        # Setup storage folder
        mkdir -p storage/home
        sudo useradd -m -d /home/vpsuser -s /bin/bash vpsuser || true
        sudo usermod -d $PWD/storage/home vpsuser
        echo "vpsuser:123456" | sudo chpasswd

        # Enable SSH
        sudo service ssh start

        # Tailscale (auto login)
        curl -fsSL https://tailscale.com/install.sh | sh
        sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTHKEY }} --ssh --hostname=persistent-vps

        # SSHX Install
        curl -fsSL https://sshx.io/get | sh
        sudo mv sshx /usr/local/bin/sshx || true
        chmod +x /usr/local/bin/sshx

        # Print Access Info
        echo "=================="
        echo "Username: vpsuser"
        echo "Password: 123456"
        echo "Public IPv4: $(curl -s4 https://ifconfig.me)"
        echo "Tailscale IP: $(tailscale ip -4)"
        echo "SSHX: $(sshx --print-only)"
        echo "=================="

        # Keep alive
        sleep 6h
