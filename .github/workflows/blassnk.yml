name: Deploy VPS Bot with SSHx + Tailscale

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'  # Restart every 6 hours

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
    - name: Setup user info
      run: |
        echo "Reading user input"
        echo "VPS_NAME=$(cat name.txt)" >> $GITHUB_ENV
        echo "VPS_PASS=$(cat pass.txt)" >> $GITHUB_ENV

    - name: Install dependencies
      run: |
        sudo apt update && sudo apt install -y curl unzip wget openssh-server zip

    - name: Setup Tailscale
      run: |
        curl -fsSL https://tailscale.com/install.sh | sh
        sudo tailscale up --authkey ${{ secrets.TAILSCALE_AUTH_KEY }} --ssh
        sleep 5
        TS_IP=$(tailscale ip -4)
        echo "TS_IP=$TS_IP" >> $GITHUB_ENV

    - name: Install SSHx (Manual Non-blocking)
      run: |
        mkdir -p ~/sshx && cd ~/sshx
        curl -L https://s3.amazonaws.com/sshx/sshx-x86_64-unknown-linux-musl.tar.gz -o sshx.tar.gz
        tar -xvzf sshx.tar.gz
        chmod +x sshx
        sudo mv sshx /usr/local/bin/
        cd ~
        touch dummyfile
        nohup sshx dummyfile > sshx_log.txt 2>&1 &
        sleep 5
        SSHX_URL=$(grep -Eo 'https://sshx.io/s/[a-zA-Z0-9]+' sshx_log.txt | head -n 1)
        echo "SSHX_URL=$SSHX_URL" >> $GITHUB_ENV

    - name: Start SSH
      run: |
        sudo service ssh start
        echo -e "${{ env.VPS_PASS }}\n${{ env.VPS_PASS }}" | sudo passwd $USER

    - name: Backup VPS Files to Google Drive
      run: |
        zip -r backup-${{ env.VPS_NAME }}.zip . || true
        curl -sL https://raw.githubusercontent.com/prasmussen/gdrive/master/install.sh | bash
        ./gdrive upload backup-${{ env.VPS_NAME }}.zip || true

    - name: Send DM with SSHx + Tailscale Info (using webhook or bot)
      env:
        DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
      run: |
        curl -H "Content-Type: application/json" -X POST -d "{
          \"content\": \"üîê **Your VPS is Ready**\n\n**Name:** ${{ env.VPS_NAME }}\n**Password:** ${{ env.VPS_PASS }}\n**Tailscale IP:** ${{ env.TS_IP }}\n**SSHx Link:** ${{ env.SSHX_URL }}\n\nUse \`ssh user@${{ env.TS_IP }}\` or SSHx link to connect.\"
        }" $DISCORD_WEBHOOK
