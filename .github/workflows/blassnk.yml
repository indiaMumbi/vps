name: Persistent VPS with Tailscale + Tmate

on:
  workflow_dispatch:
    inputs:
      username:
        description: 'Username'
        required: true
      password:
        description: 'Password'
        required: true
      discord_webhook:
        description: 'Discord Webhook URL'
        required: true
  schedule:
    - cron: '0 */6 * * *'  # Restart every 6 hours

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 357
    steps:
    - name: Cache VPS files
      uses: actions/cache@v3
      with:
        path: storage
        key: persistent-storage

    - name: Setup VPS
      run: |
        set -e
        sudo apt update
        sudo apt install -y curl unzip openssh-server tmate

        mkdir -p storage/home/${{ github.event.inputs.username }}
        sudo useradd -m -d $PWD/storage/home/${{ github.event.inputs.username }} -s /bin/bash ${{ github.event.inputs.username }} || true
        sudo usermod -d $PWD/storage/home/${{ github.event.inputs.username }} ${{ github.event.inputs.username }}
        echo "${{ github.event.inputs.username }}:${{ github.event.inputs.password }}" | sudo chpasswd

        sudo service ssh start

        # Setup tailscale
        curl -fsSL https://tailscale.com/install.sh | sh
        sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTHKEY }} --ssh --hostname=vps-${{ github.run_id }}

        # Setup tmate session
        tmate -S /tmp/tmate.sock new-session -d
        tmate -S /tmp/tmate.sock wait tmate-ready
        TMATE_SSH=$(tmate -S /tmp/tmate.sock display -p '#{tmate_ssh}')

        IPV4=$(curl -s4 https://ifconfig.me)
        TAILSCALE_IP=$(tailscale ip -4)

        echo "Saving VPS Info to file..."
        echo "Username: ${{ github.event.inputs.username }}" > vps_info.txt
        echo "Password: ${{ github.event.inputs.password }}" >> vps_info.txt
        echo "IPv4: $IPV4" >> vps_info.txt
        echo "Tailscale IP: $TAILSCALE_IP" >> vps_info.txt
        echo "Tailscale SSH: ssh ${{ github.event.inputs.username }}@$TAILSCALE_IP" >> vps_info.txt
        echo "Tmate SSH: $TMATE_SSH" >> vps_info.txt

        curl -H "Content-Type: application/json" \
          -X POST \
          -d "{\"content\": \"âœ… **Your VPS is Ready!**\\nğŸ‘¤ Username: ${{ github.event.inputs.username }}\\nğŸ” Password: ${{ github.event.inputs.password }}\\nğŸŒ IPv4: $IPV4\\nğŸ”— Tailscale SSH: \`ssh ${{ github.event.inputs.username }}@$TAILSCALE_IP\`\\nğŸ”— Tmate SSH: \`$TMATE_SSH\`\"}" \
          "${{ github.event.inputs.discord_webhook }}"

        sleep 6h
