name: Persistent VPS with tmate + Tailscale

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'  # Restart every 6 hours

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 357
    steps:
    - name: Setup persistent volume
      uses: actions/cache@v3
      with:
        path: storage
        key: persistent-storage

    - name: Setup VPS
      run: |
        sudo apt update
        sudo apt install -y curl unzip openssh-server tmate

        # Create persistent user
        mkdir -p storage/home
        sudo useradd -m -d /home/myuser -s /bin/bash myuser || true
        sudo usermod -d $PWD/storage/home myuser
        echo "myuser:123456" | sudo chpasswd

        # Start SSH service
        sudo service ssh start

        # Install Tailscale (without browser login)
        curl -fsSL https://tailscale.com/install.sh | sh
        sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTHKEY }} --ssh --hostname=vps-tmate

        # Start tmate
        tmate -F &

        # Output info
        echo "=============================="
        echo "Username: myuser"
        echo "Password: 123456"
        echo "IPv4: $(curl -s4 https://ifconfig.me)"
        echo "Tailscale IP: $(tailscale ip -4)"
        echo "Tailscale SSH: ssh myuser@$(tailscale ip -4)"
        echo "=============================="

        # Keep VPS alive
        sleep 6h
