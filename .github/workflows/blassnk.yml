name: Persistent VPS with tmate + Tailscale

on:
  workflow_dispatch:
    inputs:
      vps_name:
        description: "VPS Name"
        required: true
      vps_pass:
        description: "VPS Password"
        required: true
      discord_id:
        description: "Discord User ID"
        required: true

  schedule:
    - cron: '0 */6 * * *'  # Restart every 6 hours

env:
  VPS_DIR: "./vps_data"

jobs:
  build:
    runs-on: ubuntu-latest
    name: Start Persistent VPS
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Load Cached VPS Data
        id: cache-restore
        uses: actions/cache@v4
        with:
          path: ${{ env.VPS_DIR }}
          key: ${{ github.event.inputs.vps_name || 'default' }}-vps-cache

      - name: Setup VPS Directory
        run: |
          mkdir -p $VPS_DIR
          echo "${{ github.event.inputs.vps_pass || 'defaultpass' }}" > $VPS_DIR/pass.txt

      - name: Install Tools
        run: |
          sudo apt update
          sudo apt install -y neofetch screen curl wget

      - name: Tailscale Setup
        uses: tailscale/github-action@v2
        with:
          authkey: ${{ secrets.TAILSCALE_AUTHKEY }}
          hostname: ${{ github.event.inputs.vps_name || 'vps' }}
          args: up --ssh

      - name: Start tmate
        id: tmate
        uses: mxschmitt/action-tmate@v3
        with:
          limit-access-to-actor: false

      - name: Generate VPS Info
        run: |
          echo "Name: ${{ github.event.inputs.vps_name || 'vps' }}" > info.txt
          echo "Password: $(cat $VPS_DIR/pass.txt)" >> info.txt
          echo "Tailscale IP: $(tailscale ip -4)" >> info.txt
          echo "Tmate SSH: ${{ steps.tmate.outputs.ssh }}" >> info.txt
          echo "Public IP: $(curl -s ifconfig.me)" >> info.txt

      - name: Save VPS State (Cache)
        uses: actions/cache/save@v4
        with:
          path: ${{ env.VPS_DIR }}
          key: ${{ github.event.inputs.vps_name || 'default' }}-vps-cache

      - name: Upload Info File
        uses: actions/upload-artifact@v4
        with:
          name: vps-info
          path: info.txt

      - name: DM User on Discord
        run: |
          curl -X POST https://discord.com/api/v10/users/${{ github.event.inputs.discord_id }}/messages \
          -H "Authorization: Bot ${{ secrets.DISCORD_BOT_TOKEN }}" \
          -H "Content-Type: application/json" \
          -d @- << EOF
          {
            "content": "**🔁 VPS Auto-Restarted / New Session**\n\`\`\`\n$(cat info.txt)\n\`\`\`"
          }
EOF
