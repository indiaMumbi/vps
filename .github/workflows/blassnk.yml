name: Persistent VPS with Tailscale + SSHX

on:
  workflow_dispatch:
    inputs:
      USERNAME:
        description: 'Your SSH Username'
        required: true
      PASSWORD:
        description: 'Your SSH Password'
        required: true
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours restart

jobs:
  run-vps:
    runs-on: ubuntu-latest
    name: VPS Persistent Runner
    steps:

    - name: Set user-defined env
      run: |
        echo "USER=${{ github.event.inputs.USERNAME }}" >> $GITHUB_ENV
        echo "PASS=${{ github.event.inputs.PASSWORD }}" >> $GITHUB_ENV

    - name: Setup Swap and Install Packages
      run: |
        sudo fallocate -l 2G /swapfile
        sudo chmod 600 /swapfile
        sudo mkswap /swapfile
        sudo swapon /swapfile
        sudo apt update -y
        sudo apt install curl unzip net-tools -y

    - name: Install Tailscale
      run: |
        curl -fsSL https://tailscale.com/install.sh | sh
        sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTHKEY }} --ssh --accept-routes

    - name: Install SSHX (fixed)
      run: |
        curl -L https://s3.amazonaws.com/sshx/sshx-x86_64-unknown-linux-musl.tar.gz -o sshx.tar.gz
        tar -xzf sshx.tar.gz
        sudo mv sshx /usr/local/bin/
        sudo chmod +x /usr/local/bin/sshx

    - name: Setup SSH Access
      run: |
        sudo useradd -m $USER
        echo "$USER:$PASS" | sudo chpasswd
        sudo usermod -aG sudo $USER
        sudo systemctl restart ssh

    - name: Show Access Info + Send to Discord
      env:
        DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
      run: |
        IP=$(curl -s4 https://ifconfig.me)
        TUNIP=$(tailscale ip -4)
        SSHX_URL=$(sshx --url 2>/dev/null || echo "SSHX failed")
        echo "SSH: ssh $USER@$IP"
        echo "TAILSCALE: ssh $USER@$TUNIP"
        curl -H "Content-Type: application/json" \
          -X POST \
          -d "{\"content\": \"ğŸŸ¢ VPS is Live\n**Username:** $USER\n**Password:** (hidden)\nğŸŒ Public IP: \`$IP\`\nğŸ”— Tailscale IP: \`$TUNIP\`\nğŸ§· SSHX: $SSHX_URL\"}" \
          $DISCORD_WEBHOOK

    - name: Run Long Process (Sleep for 6 hours)
      run: sleep 21600  # 6 hours in seconds
